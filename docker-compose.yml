services:
  web:
    image: node:24-alpine
    working_dir: /app
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    command: >
      sh -c "corepack enable &&
             corepack prepare yarn@1.22.22 --activate &&
             yarn install &&
             yarn dev -p 3000 -H 0.0.0.0"
    environment:
      - NODE_ENV=development
      # 브라우저가 접근하는 공개 WS 주소
      - NEXT_PUBLIC_WS_URL=http://localhost:3001
      - NEXT_PUBLIC_NOISECRAFT_WS_URL=http://localhost:4000
      # (옵션) 서버 내부 통신용 내부 주소
      - REALTIME_INTERNAL_URL=http://game:3001
    depends_on:
      - game
      - noisecraft

  game:
    image: node:24-alpine
    working_dir: /server
    ports:
      - "3001:3001"
    volumes:
      - ./realtime:/server
      - game_node_modules:/server/node_modules
    command: >
      sh -c "corepack enable &&
             corepack prepare yarn@1.22.22 --activate &&
             yarn install &&
             yarn dev"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - HOST=0.0.0.0
    restart: unless-stopped

  noisecraft:
    image: node:24-alpine
    working_dir: /srv
    ports:
      - "4000:4000"
    volumes:
      - ./noisecraft:/srv
      - noisecraft_node_modules:/srv/node_modules
    command: >
      sh -c "npm install --no-audit --no-fund && \
             npm run watch"
    environment:
      - NODE_ENV=development
      - HTTP_PORT_NO=4000
    restart: unless-stopped

volumes:
  node_modules:
  game_node_modules:
  noisecraft_node_modules:
