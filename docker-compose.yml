services:
  web:
    image: node:24-alpine
    cpus: 0.5 # 논리 CPU 2개까지만 사용
    mem_limit: 4g # 메모리 4GB 제한
    memswap_limit: 4g # 스왑도 동일하게 제한 (선택)
    working_dir: /app
    # 외부 직접 접근 포트
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    command: >
      sh -c "corepack disable || true &&
             npm install -g yarn@1.22.22 --no-audit --no-fund &&
             YARN_PRODUCTION=false yarn install &&
             yarn prod"
    environment:
      - NODE_ENV=production
      # 브라우저에서 접속하는 공개 WS/HTTP 주소
      # 로컬 개발에서는 localhost:3001 / localhost:4000 사용,
      # EC2 배포 시에는 /socket 및 HTTPS 도메인으로 덮어쓰기 가능
      - NEXT_PUBLIC_WS_URL=/socket
      - NEXT_PUBLIC_NOISECRAFT_WS_URL=https://ncft.intersection-nextjs.site
      # 호스트 URL (브라우저 기준 origin)
      - NEXT_PUBLIC_HOST_URL=https://intersection-nextjs.site
      # 내부 통신용 주소 (컨테이너 간)
      - REALTIME_INTERNAL_URL=http://game:3001
      - NEXT_PUBLIC_PERSONAL_AUDIO_MODE=both
      - NEXT_PUBLIC_NOISECRAFT_PERSONAL_PATCH_SRC=/examples/indiv_audio_map_v2.ncft
      - NEXT_PUBLIC_NOISECRAFT_GLOBAL_PATCH_SRC=/examples/glb_audio_map.ncft
    depends_on:
      - game
      - noisecraft

  game:
    image: node:24-alpine
    cpus: 1
    mem_limit: 2g
    memswap_limit: 2g
    working_dir: /server
    ports:
      - "3001:3001"
    volumes:
      - ./realtime:/server
      - game_node_modules:/server/node_modules
    command: >
      sh -c "corepack disable || true &&
             npm install -g yarn@1.22.22 --no-audit --no-fund &&
             yarn install &&
             yarn dev"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - HOST=0.0.0.0
      - SOCKET_PATH=/socket
    restart: unless-stopped

  noisecraft:
    image: node:24-alpine
    cpus: 1
    mem_limit: 1g
    memswap_limit: 1g
    working_dir: /srv
    ports:
      - "4000:4000"
    volumes:
      - ./noisecraft:/srv
      - noisecraft_node_modules:/srv/node_modules
    command: >
      sh -c "npm install --no-audit --no-fund && \
             npm run watch"
    environment:
      - NODE_ENV=development
      - HTTP_PORT_NO=4000
    restart: unless-stopped

  caddy:
    image: caddy:2
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
    depends_on:
      - web
      - noisecraft

volumes:
  node_modules:
  game_node_modules:
  noisecraft_node_modules:

networks:
  default:
    name: intersection-dev
