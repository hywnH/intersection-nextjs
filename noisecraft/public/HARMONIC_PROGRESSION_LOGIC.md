# 화성진행 로직 설계

## 개요
현재 접속한 파티클들의 음 정보를 수집하여, 사이클마다 자연스러운 화성진행을 구성하는 시스템

## 핵심 아이디어

### 1. 음 정보 수집
- 현재 접속한 모든 파티클의 음(note, 0-11) 수집
- 파티클이 많을수록 더 다양한 음 선택 가능

### 2. 화성진행 생성
- 8-step 사이클마다 화성진행 선택 (예: I-V-vi-IV)
- 각 사이클은 4개의 코드로 구성 (2 steps per chord)
- 사용 가능한 음과 가장 잘 맞는 진행 선택

### 3. 음 선별 알고리즘
각 step마다:
1. **코드 톤 우선**: 현재 코드의 톤이 있으면 우선 선택
2. **안정도 우선순위**: 
   - Perfect 5th (7) > 3rd (3,4) > 4th/6th (5,8,9)
3. **Voice Leading**: 이전 코드에서 자연스러운 이동

### 4. Voice 할당
- Bass: 가장 낮은 음
- Baritone: 중간 음
- Tenor: 가장 높은 음

## 구현 방법

### Option 1: 사이클 기반 화성진행 (추천)
```javascript
// 각 사이클(8 steps)마다 화성진행 생성
// Step 0-1: Chord 1
// Step 2-3: Chord 2
// Step 4-5: Chord 3
// Step 6-7: Chord 4
```

**장점:**
- 자연스러운 화성진행
- 예측 가능한 구조
- Voice leading이 부드러움

**단점:**
- 파티클이 적을 때는 코드 톤이 부족할 수 있음

### Option 2: 하이브리드 방식 (추천)
```javascript
// 파티클 수에 따라 동적으로 전환
// - 파티클 < 3: 단순 코드 (3음)
// - 파티클 3-6: 화성진행 (4 코드)
// - 파티클 > 6: 복잡한 진행 + 확장 코드
```

**장점:**
- 파티클 수에 따라 적응적
- 초반에도 안정적
- 후반에는 더 풍부한 하모니

### Option 3: 실시간 적응형
```javascript
// 매 step마다 현재 코드와 다음 코드를 고려
// 파티클들의 음을 실시간으로 평가하여 최적의 음 선택
```

**장점:**
- 가장 유연함
- 파티클 변화에 즉각 반응

**단점:**
- 계산 비용이 높음
- 예측 불가능할 수 있음

## 추천 구현: 하이브리드 방식

### 단계별 로직

1. **음 정보 수집**
   ```javascript
   const particleNotes = particles.map(p => {
     return p.tone !== undefined ? (p.tone % 12) : p.getActiveNoteIndex();
   }).filter(note => note >= 0 && note < 12);
   ```

2. **화성진행 선택** (사이클마다)
   ```javascript
   // 사용 가능한 음과 가장 잘 맞는 진행 선택
   // 예: I-V-vi-IV (C-G-Am-F)
   ```

3. **각 step마다 음 선별**
   ```javascript
   // 현재 코드 톤 중에서 파티클이 가진 음 우선 선택
   // 없으면 안정도 순으로 선택
   ```

4. **Voice 할당**
   ```javascript
   // 선택된 음을 pitch 순으로 정렬
   // Bass < Baritone < Tenor
   ```

## 통합 방법

### 현재 시스템과의 통합
1. `HarmonicProgressionGenerator` 인스턴스 생성
2. 매 업데이트마다:
   - 파티클 음 수집
   - 현재 step에 맞는 화성진행 생성
   - 음 선별 및 voice 할당
   - 시퀀서 패턴 업데이트

### 기존 로직과의 차이점
- **기존**: 각 파티클이 랜덤 음 할당 → 위치만 결정
- **새로운**: 파티클 음 수집 → 화성진행 생성 → 최적 음 선별 → voice 할당

## 예시 시나리오

### 시나리오 1: 파티클 3개 (C, E, G)
- 화성진행: I (C Major)
- Step 0-1: C-E-G (C Major 코드)
- Step 2-3: C-E-G (계속)
- Step 4-5: C-E-G
- Step 6-7: C-E-G

### 시나리오 2: 파티클 5개 (C, D, E, G, A)
- 화성진행: I-V-vi-IV (C-G-Am-F)
- Step 0-1: C-E-G (I)
- Step 2-3: G-B-D (V) - D는 없으므로 G-B만 사용
- Step 4-5: A-C-E (vi)
- Step 6-7: F-A-C (IV) - F는 없으므로 A-C만 사용

### 시나리오 3: 파티클 8개 (다양한 음)
- 화성진행: I-vi-IV-V (C-Am-F-G)
- 각 코드에서 최적의 음 선별
- Voice leading 고려하여 부드러운 전환

